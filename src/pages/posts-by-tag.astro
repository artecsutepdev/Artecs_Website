---
import type { CollectionEntry } from "astro:content";
import { getAllPosts, groupPostsByTag } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import PostPreview from "@/components/blog/PostPreview.astro";
import { collectionDateSort } from "@/utils/date";

const allPosts = await getAllPosts();
const sorted = allPosts.sort(collectionDateSort);
const grouped = groupPostsByTag(sorted);
const tags = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

---

<PageLayout meta={{ title: "Posts grouped by tag", description: "All posts grouped by their tags." }}>
  <h1 class="mb-6">Posts grouped by tag</h1>

  {tags.map((tag) => (
    <section id={`tag-${tag}`} class="mb-10">
      <h2 class="mb-3">#{tag} <span class="text-sm text-muted">({grouped[tag].length})</span></h2>
      <ul class="space-y-4">
        {grouped[tag].map((post: CollectionEntry<"post">) => (
          <li class="grid gap-2 sm:grid-cols-[auto_1fr]">
            <PostPreview as="h3" post={post} />
          </li>
        ))}
      </ul>
    </section>
  ))}
</PageLayout>
